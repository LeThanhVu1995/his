{
  "code": "patient-admission",
  "name": "Patient Admission Workflow",
  "version": 1,
  "spec": {
    "steps": [
      {
        "id": "validate-patient",
        "name": "Validate Patient Information",
        "http": {
          "method": "POST",
          "url": "http://patient-service/api/v1/patients/validate",
          "body": {
            "patient_id": "{{ctx.patient_id}}"
          },
          "save_as": "patient_validation",
          "timeout_secs": 10
        },
        "retry": {
          "max_attempts": 3,
          "backoff": {
            "type": "exponential",
            "initial_secs": 1,
            "max_secs": 30
          }
        },
        "resilience": {
          "circuit": {
            "service": "patient-service",
            "fail_threshold": 5,
            "half_open_after_secs": 30
          }
        },
        "compensate": {
          "http": {
            "method": "DELETE",
            "url": "http://patient-service/api/v1/patients/{{ctx.patient_id}}/validation"
          }
        }
      },
      {
        "id": "check-insurance",
        "name": "Check Insurance Coverage",
        "http": {
          "method": "POST",
          "url": "http://insurance-service/api/v1/coverage/check",
          "body": {
            "patient_id": "{{ctx.patient_id}}",
            "insurance_number": "{{ctx.insurance_number}}"
          },
          "save_as": "insurance_coverage",
          "timeout_secs": 15
        },
        "retry": {
          "max_attempts": 2,
          "backoff": {
            "type": "exponential",
            "initial_secs": 2,
            "max_secs": 20
          }
        },
        "resilience": {
          "circuit": {
            "service": "insurance-service",
            "fail_threshold": 3,
            "half_open_after_secs": 20
          }
        }
      },
      {
        "id": "assign-room",
        "name": "Assign Hospital Room with Dependencies",
        "dag": {
          "nodes": [
            {
              "id": "check-room-availability",
              "steps": [
                {
                  "id": "get-rooms",
                  "name": "Get Available Rooms",
                  "http": {
                    "method": "GET",
                    "url": "http://room-service/api/v1/rooms/available",
                    "save_as": "available_rooms",
                    "timeout_secs": 10
                  },
                  "resilience": {
                    "circuit": {
                      "service": "room-service",
                      "fail_threshold": 3,
                      "half_open_after_secs": 15
                    }
                  }
                }
              ]
            },
            {
              "id": "check-equipment",
              "steps": [
                {
                  "id": "get-equipment",
                  "name": "Get Available Equipment",
                  "http": {
                    "method": "GET",
                    "url": "http://equipment-service/api/v1/equipment/available",
                    "save_as": "available_equipment",
                    "timeout_secs": 10
                  },
                  "resilience": {
                    "circuit": {
                      "service": "equipment-service",
                      "fail_threshold": 3,
                      "half_open_after_secs": 15
                    }
                  }
                }
              ]
            },
            {
              "id": "assign-specific-room",
              "steps": [
                {
                  "id": "assign-room",
                  "name": "Assign Specific Room",
                  "http": {
                    "method": "POST",
                    "url": "http://room-service/api/v1/rooms/assign",
                    "body": {
                      "patient_id": "{{ctx.patient_id}}",
                      "room_preference": "{{ctx.available_rooms[0].id}}",
                      "equipment_required": "{{ctx.available_equipment}}"
                    },
                    "save_as": "assigned_room",
                    "timeout_secs": 15
                  },
                  "retry": {
                    "max_attempts": 2,
                    "backoff": {
                      "type": "exponential",
                      "initial_secs": 1,
                      "max_secs": 10
                    }
                  },
                  "resilience": {
                    "circuit": {
                      "service": "room-service",
                      "fail_threshold": 3,
                      "half_open_after_secs": 15
                    }
                  }
                }
              ]
            }
          ],
          "edges": [
            {
              "from": "check-room-availability",
              "to": "assign-specific-room"
            },
            {
              "from": "check-equipment",
              "to": "assign-specific-room"
            }
          ]
        }
      },
      {
        "id": "make-decision",
        "name": "Make Admission Decision",
        "switch": {
          "condition": "ctx.insurance_coverage.approved == true && ctx.available_rooms_0.length > 0",
          "cases": [
            {
              "condition": "true",
              "steps": [
                {
                  "id": "approve-admission",
                  "name": "Approve Admission",
                  "http": {
                    "method": "POST",
                    "url": "http://admission-service/api/v1/admissions",
                    "body": {
                      "patient_id": "{{ctx.patient_id}}",
                      "room_id": "{{ctx.available_rooms_0[0].id}}",
                      "insurance_approved": true
                    },
                    "save_as": "admission_result"
                  }
                },
                {
                  "id": "notify-success",
                  "name": "Notify Success",
                  "kafka-publish": {
                    "topic": "patient-admissions",
                    "key": "{{ctx.patient_id}}",
                    "payload": {
                      "event": "admission_approved",
                      "patient_id": "{{ctx.patient_id}}",
                      "admission_id": "{{ctx.admission_result.id}}"
                    },
                    "timeout_secs": 5
                  },
                  "retry": {
                    "max_attempts": 3,
                    "backoff": {
                      "type": "exponential",
                      "initial_secs": 1,
                      "max_secs": 10
                    }
                  }
                }
              ]
            },
            {
              "condition": "false",
              "steps": [
                {
                  "id": "reject-admission",
                  "name": "Reject Admission",
                  "http": {
                    "method": "POST",
                    "url": "http://admission-service/api/v1/admissions/reject",
                    "body": {
                      "patient_id": "{{ctx.patient_id}}",
                      "reason": "Insurance not approved or no rooms available"
                    },
                    "save_as": "rejection_result"
                  }
                },
                {
                  "id": "notify-rejection",
                  "name": "Notify Rejection",
                  "kafka-publish": {
                    "topic": "patient-admissions",
                    "key": "{{ctx.patient_id}}",
                    "payload": {
                      "event": "admission_rejected",
                      "patient_id": "{{ctx.patient_id}}",
                      "reason": "{{ctx.rejection_result.reason}}"
                    }
                  }
                }
              ]
            }
          ]
        }
      },
      {
        "id": "wait-for-confirmation",
        "name": "Wait for Doctor Confirmation",
        "event-trigger": {
          "event": "doctor_confirmation",
          "payload": {
            "patient_id": "{{ctx.patient_id}}",
            "admission_id": "{{ctx.admission_result.id}}"
          },
          "wait_for": {
            "timeout": 300,
            "save_as": "doctor_confirmation"
          }
        }
      },
      {
        "id": "finalize-admission",
        "name": "Finalize Admission",
        "http": {
          "method": "PUT",
          "url": "http://admission-service/api/v1/admissions/{{ctx.admission_result.id}}/finalize",
          "body": {
            "doctor_confirmed": "{{ctx.doctor_confirmation.confirmed}}",
            "notes": "{{ctx.doctor_confirmation.notes}}"
          },
          "save_as": "final_admission",
          "timeout_secs": 10
        },
        "retry": {
          "max_attempts": 2,
          "backoff": {
            "type": "exponential",
            "initial_secs": 1,
            "max_secs": 5
          }
        },
        "resilience": {
          "circuit": {
            "service": "admission-service",
            "fail_threshold": 3,
            "half_open_after_secs": 15
          }
        }
      },
      {
        "id": "send-notifications",
        "name": "Send Notifications",
        "parallel": {
          "branches": [
            {
              "steps": [
                {
                  "id": "notify-patient",
                  "name": "Notify Patient",
                  "kafka-publish": {
                    "topic": "notifications",
                    "key": "{{ctx.patient_id}}",
                    "payload": {
                      "type": "admission_confirmed",
                      "patient_id": "{{ctx.patient_id}}",
                      "room_number": "{{ctx.final_admission.room_number}}"
                    }
                  }
                }
              ]
            },
            {
              "steps": [
                {
                  "id": "notify-staff",
                  "name": "Notify Medical Staff",
                  "kafka-publish": {
                    "topic": "staff-notifications",
                    "key": "{{ctx.final_admission.room_id}}",
                    "payload": {
                      "type": "new_patient",
                      "patient_id": "{{ctx.patient_id}}",
                      "room_id": "{{ctx.final_admission.room_id}}",
                      "admission_time": "{{ctx.final_admission.created_at}}"
                    }
                  }
                }
              ]
            }
          ]
        }
      }
    ]
  }
}
